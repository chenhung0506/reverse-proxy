worker_processes auto;
pid /tmp/nginx.pid;
error_log /var/log/nginx/error.log;

events {
  worker_connections 1024;
  use epoll;
  multi_accept on;
}

http {
  sendfile            on;
  tcp_nopush          on;
  tcp_nodelay         on;
  keepalive_timeout   65;
  types_hash_max_size 2048;

  log_format timed_combined '$remote_addr - '
    '"$request" $status $body_bytes_sent '
    '"$http_referer" "$http_user_agent" '
    '$request_time $upstream_response_time $pipe';

  access_log /dev/stdout timed_combined;
  # this is necessary for us to be able to disable request buffering in all cases
  proxy_http_version 1.1;

  # include /etc/nginx/conf.d/*.conf;
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  underscores_in_headers on;
  add_header X-Frame-Options "DENY";
  add_header X-Content-Type-Options nosniff;
  add_header X-XSS-Protection "1; mode=block";
  add_header Strict-Transport-Security "max-age=0; includeSubdomains; preload";
  keepalive_timeout  120s;
  client_max_body_size 25M;
  proxy_buffers 8 16k;
  proxy_buffer_size 32k;

  resolver 8.8.8.8 8.8.4.4 valid=300s;
  resolver_timeout 5s;
  location ~ /\.ht {
      deny all;
  }

  server {
      listen 80;
      listen [::]:80;
      server_name _;

      location / {
          proxy_http_version 1.1;
          add_header X-Frame-Options "DENY";
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header Upgrade $http_upgrade;
          proxy_hide_header X-Frame-Options;
          proxy_pass ${BF_IP}:81;
          proxy_connect_timeout 600000s;
          proxy_read_timeout 600000s;
          proxy_send_timeout 600000s;
          # proxy_set_header X-Forwarded-Proto https;
      }
  }

  server {
      listen 8080;
      listen [::]:8080;
      server_name _;

      location / {
          proxy_http_version 1.1;
          add_header X-Frame-Options "DENY";
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header Upgrade $http_upgrade;
          proxy_hide_header X-Frame-Options;
          proxy_pass ${BF_IP}:8081;
          proxy_connect_timeout 600000s;
          proxy_read_timeout 600000s;
          proxy_send_timeout 600000s;
          # proxy_set_header X-Forwarded-Proto https;
      }
  }

}
