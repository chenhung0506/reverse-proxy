version: "3.7"
services:
  reverse-proxy:
    container_name: reverse-proxy
    image: harbor.chlin.tk/nginx/reverse-proxy:${TAG}
    logging:
      driver: json-file
      options:
        max-file: "10"
        max-size: "100m"
    env_file:
      - dev.env
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./conf.d:/etc/nginx/conf.d/
      - ./cert/harbor_cert:/etc/cert
      - ./cert/live:/etc/letsencrypt/live
    ports:
      - 80:80
      - 443:443
    restart: always
    networks: 
      - nginx
  resume:
    container_name: resume
    image: harbor.chlin.tk/vue/resume:ccb87bb-20210506-0214
    volumes:
      - /etc/localtime:/etc/localtime
    environment:
      - IS_LOADED=LOAD_ENV_FILE_SUCCESS
      - PORT=3000
    ports:
      - 3000:3000
    restart: always
    networks: 
      - nginx
  linebot:
    container_name: linebot
    image: harbor.chlin.tk/python/linebot:3984240-20210509-0230
    volumes:
      - /etc/localtime:/etc/localtime
      - ~/volumes/linebot:/usr/src/app/logs
    ports:
      - 3001:3001
    restart: always
    networks: 
      - nginx
    environment:
      - TZ=Asia/Taipei
      - IS_LOADED=LOAD_ENV_FILE_SUCCESS
      - PORT=3001
      - SERVER_IP=127.0.0.1
      - LOG_LEVEL=INFO
      - LOG_FOLDER_PATH=logs/
      - DOCKER_NETWORK='alpine-net'
      - RESUME_HEALTH_API='https://resume-chlin.herokuapp.com/healthckeck'
      - AVALON_HEALTH_API='https://avalon-chlin.herokuapp.com/healthcheck'
      - CHANNEL_SECRET='a6f79abe583861e684912f1de6c2b256'
      - CHANNEL_TOKEN='AWWJaUg9KA//spwKcDz2EoWN9OnA3mRPCAk0lFlmUr9cr7ZLHUcNvLxJ/KE2KN64+YkK0I8Vjxx2gVllw5Im82OeAvPTc40wS7HLHS6NdcRVhUMcVR808xLIjSHcmejrYKhtkZb9fPJTX2sT9FU+DwdB04t89/1O/w1cDnyilFU='
      - CHROMEDRIVER_PATH='http://127.0.0.1:4444/wd/hub'
      - DB_HOST='us-cdbr-east-02.cleardb.com'
      - DB_ACCOUNT='bdef9ef0984947'
      - DB_PASSWORD='0b65d70f'
      - DB_DB='heroku_d38736f240fb4e6'
  websocket:
    image: harbor.chlin.tk/java/websocket:c64d70c-20210509-1623
    container_name: websocket
    environment:
      - TZ=Asia/Taipei
    volumes:
      # - ~/volumes/websocket:/usr/src/app/logs
      - /etc/timezone:/etc/localtime:ro
    ports: 
      - 3002:8080
    restart: always
    networks: 
      - nginx
  websocket-ui:
    image: harbor.chlin.tk/vue/websocket-ui:78ee43a-20210510-0050
    container_name: websocket-ui
    environment:
      - TZ=Asia/Taipei
    volumes:
      - /etc/timezone:/etc/localtime:ro
    ports: 
      - 3003:80
    restart: always
    networks: 
      - nginx
  wedding:
    container_name: wedding
    image: harbor.chlin.tk/vue/wedding:8548fb0_20210407120454
    volumes:
      - /etc/localtime:/etc/localtime
    ports:
      - 8050:8050
    restart: always
    networks: 
      - nginx
  university:
    image: harbor.chlin.tk/python/university:d5f93b7-20210401-0054
    container_name: university
    environment:
      - TZ=Asia/Taipei
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ~/volumes/university:/usr/src/app/logs
      - ~/volumes/university/upload:/usr/src/app/university/upload
      - ~/.ssh/known_hosts:/root/.ssh/known_hosts
    ports: 
      - 8336:8336
    environment:
      - IS_LOADED=LOAD_ENV_FILE_SUCCESS
      - PORT=8336
      - LOG_LEVEL=INFO
      - LOG_FOLDER_PATH=logs/
      - DB_HOST=172.17.0.1
      - DB_PORT=3306
      - DB_ACCOUNT='root'
      - DB_PASSWORD='password'
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8336/healthCheck || exit 1"]
      interval: 60s
      timeout: 10s
      start_period: 10s
    restart: always
    networks: 
      - nginx
  vote:
    image: harbor.chlin.tk/python/vote:8d8530f-20210310-1843 
    container_name: vote
    environment:
      - TZ=Asia/Taipei
      - IS_LOADED=LOAD_ENV_FILE_SUCCESS
      - PORT=8333
      - LOG_LEVEL=INFO
      - START_TIME=23
      - END_TIME=0
      - CALL_DIRECTION=outbound
      - LOG_FOLDER_PATH=logs/
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ~/volumes/vote:/usr/src/app/logs
    ports: 
      - 8333:8333
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8333/healthCheck || exit 1"]
      interval: 60s
      timeout: 10s
      start_period: 10s
    restart: always
    networks: 
      - nginx
  mysql:
    image: mysql:5.7
    container_name: mysql
    restart: always
    volumes:
      - ~/volumes/mysql:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_USER: deployer
      MYSQL_PASSWORD: password
    ports:
      - "172.17.0.1:3306:3306"
    networks:
      - nginx
networks:
  nginx:
    external: true
    name: nginx
